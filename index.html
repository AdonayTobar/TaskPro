<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ProTask</title>
    <!-- ICONO DE LA APP -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-task.png">

    <!-- ICONO PARA iOS (cuando se agrega a inicio) -->
    <link rel="apple-touch-icon" href="icon-task.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- FUENTE -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Animaciones suaves */
        .modal-active {
            display: flex !important;
            animation: fadeUp 0.25s ease-out;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tabs */
        .tab-active {
            color: #111827;
            border-bottom: 3px solid #111827;
            font-weight: 800;
        }

        /* Scroll oculto */
        .modal-content-scroll {
            scrollbar-width: none;
        }

        .modal-content-scroll::-webkit-scrollbar {
            display: none;
        }

        /* Completadas */
        .task-checked {
            opacity: .45;
            filter: grayscale(1);
            transform: scale(.97);
        }
    </style>
</head>

<body class="bg-white text-slate-900 min-h-screen pb-24">

    <!-- HEADER -->
    <header class="sticky top-0 z-30 bg-white border-b border-slate-100">
        <div class="px-5 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight">ProTask</h1>
                <p id="today" class="text-xs text-slate-400 font-medium mt-0.5"></p>
            </div>
            <div class="bg-slate-900 text-white p-2 rounded-xl">
                <i data-lucide="check-square" class="w-5 h-5"></i>
            </div>
        </div>
    </header>

    <!-- NAV -->
    <nav class="sticky top-[72px] z-20 flex justify-around bg-white border-b border-slate-100 text-sm">
        <button id="nav-today" onclick="setView('today')" class="flex-1 py-4 text-slate-400">Hoy</button>
        <button id="nav-week" onclick="setView('week')" class="flex-1 py-4 text-slate-400">Semana</button>
        <button id="nav-month" onclick="setView('month')" class="flex-1 py-4 text-slate-400">Mes</button>
        <button id="nav-completed" onclick="setView('completed')" class="flex-1 py-4 text-slate-400">Hechas</button>
    </nav>

    <!-- MAIN -->
    <main id="main" class="p-4 space-y-3 max-w-xl mx-auto"></main>

    <!-- EMPTY -->
    <div id="empty-state" class="hidden flex-col items-center justify-center pt-24 text-slate-300">
        <i data-lucide="inbox" class="w-16 h-16 mb-4"></i>
        <p class="text-sm">No hay tareas aqu√≠</p>
    </div>

    <!-- FAB -->
    <button onclick="openForm()"
        class="fixed bottom-6 right-6 bg-slate-900 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-xl active:scale-90 transition">
        <i data-lucide="plus" class="w-7 h-7"></i>
    </button>

    <!-- MODAL FORM -->
    <div id="formModal" class="fixed inset-0 hidden items-end bg-black/50 z-50">
        <div class="bg-white w-full rounded-t-[2.5rem] max-h-[92vh] flex flex-col">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto my-4"></div>
            <div class="px-6 pb-6 overflow-y-auto modal-content-scroll">
                <h2 id="formTitle" class="text-xl font-extrabold mb-6">Nueva tarea</h2>
                <div class="space-y-4">
                    <select id="category" onchange="renderFields()"
                        class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-3 font-medium">
                        <option value="proyecto">üèó Proyecto</option>
                        <option value="estudio">üìö Estudio</option>
                        <option value="personal">üè† Personal</option>
                    </select>
                    <div id="dynamicFields" class="space-y-4"></div>
                    <textarea id="notes" placeholder="Notas..."
                        class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-3 h-24"></textarea>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 flex gap-3">
                <button onclick="saveTask()"
                    class="flex-1 bg-slate-900 text-white rounded-2xl py-4 font-bold">Guardar</button>
                <button onclick="closeForm()"
                    class="flex-1 bg-slate-100 rounded-2xl py-4 font-semibold">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETAIL -->
    <div id="detailModal" class="fixed inset-0 hidden items-end bg-black/50 z-50">
        <div class="bg-white w-full rounded-t-[2.5rem] p-6 max-h-[90vh] overflow-y-auto">
            <div id="detailContent"></div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button id="btnEdit" class="bg-slate-900 text-white rounded-2xl py-4 font-bold">Editar</button>
                <button id="btnDelete" class="bg-red-50 text-red-600 rounded-2xl py-4 font-bold">Eliminar</button>
            </div>
            <button onclick="closeDetail()" class="w-full py-4 text-slate-400 text-sm">Cerrar</button>
        </div>
    </div>

    <!-- JS ORIGINAL (SIN CAMBIOS DE L√ìGICA) -->
    <script>
        // --- CONFIGURACI√ìN ---
        const TZ = 'America/El_Salvador';
        let tasks = JSON.parse(localStorage.getItem('todoApp_v2')) || [];
        let currentView = 'today';
        let editingTaskId = null;

        const initIcons = () => lucide.createIcons();

        const updateHeaderDate = () => {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('today').innerText = new Intl.DateTimeFormat('es-SV', options).format(new Date());
        };

        const getRelativeDate = (days) => {
            const d = new Date();
            d.setDate(d.getDate() + days);
            return d.toISOString().slice(0, 10);
        };

        // --- L√ìGICA DE D√çAS RESTANTES ---
        const getDaysDiff = (dateStr) => {
            const target = new Date(dateStr + "T00:00:00");
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = target - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const getDayBadge = (diff) => {
            if (diff < 0) return { text: `Vencido (${Math.abs(diff)}d)`, color: 'bg-slate-800 text-white' };
            if (diff === 0) return { text: 'Termina hoy', color: 'bg-orange-500 text-white' };
            if (diff <= 3) return { text: `Faltan ${diff} d√≠as`, color: 'bg-red-500 text-white' };
            if (diff <= 7) return { text: `Faltan ${diff} d√≠as`, color: 'bg-yellow-400 text-yellow-900' };
            return { text: `Faltan ${diff} d√≠as`, color: 'bg-emerald-500 text-white' };
        };

        // --- FILTRADO ---
        const isInCurrentWeek = (dateStr) => {
            const date = new Date(dateStr + "T00:00:00");
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            return date >= startOfWeek && date <= endOfWeek;
        };

        const isInCurrentMonth = (dateStr) => {
            const date = new Date(dateStr + "T00:00:00");
            const now = new Date();
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        };

        function saveStorage() {
            localStorage.setItem('todoApp_v2', JSON.stringify(tasks));
        }

        // --- FORMULARIO ---
        function openForm(taskId = null) {
            editingTaskId = taskId;
            const modal = document.getElementById('formModal');
            const titleHeader = document.getElementById('formTitle');

            if (taskId) {
                const t = tasks.find(x => x.id === taskId);
                titleHeader.innerHTML = `<i data-lucide="edit-3" class="text-indigo-600"></i> Editar Tarea`;
                document.getElementById('category').value = t.category;
                renderFields();

                if (t.category === 'proyecto') {
                    document.getElementById('client').value = t.title;
                    document.getElementById('phone').value = t.phone || '';
                    document.getElementById('material').value = t.material || '';
                    document.getElementById('address').value = t.address || '';
                    document.getElementById('closeTime').value = t.date;
                } else {
                    document.getElementById('title').value = t.title;
                    document.getElementById('deadline').value = t.date;
                }
                document.getElementById('notes').value = t.notes || '';
            } else {
                titleHeader.innerHTML = `<i data-lucide="plus-circle" class="text-indigo-600"></i> Nueva Tarea`;
                document.getElementById('category').value = 'proyecto';
                renderFields();
                document.getElementById('notes').value = '';
            }

            modal.classList.add('modal-active');
            initIcons();
        }

        function closeForm() {
            document.getElementById('formModal').classList.remove('modal-active');
            editingTaskId = null;
        }

        function renderFields() {
            const cat = document.getElementById('category').value;
            const d = document.getElementById('dynamicFields');

            if (cat === 'proyecto') {
                d.innerHTML = `
            <input id="client" placeholder="Nombre del Cliente" class="w-full border-2 border-slate-100 bg-slate-50 rounded-2xl p-3 focus:border-indigo-500 outline-none" />
            <div class="grid grid-cols-2 gap-2">
                <input id="phone" type="tel" placeholder="Tel√©fono" class="border-2 border-slate-100 bg-slate-50 rounded-2xl p-3 focus:border-indigo-500 outline-none" />
                <input id="material" placeholder="Material interesado" class="border-2 border-slate-100 bg-slate-50 rounded-2xl p-3 focus:border-indigo-500 outline-none" />
            </div>
            <input id="address" placeholder="Ubicaci√≥n / Direcci√≥n" class="w-full border-2 border-slate-100 bg-slate-50 rounded-2xl p-3 focus:border-indigo-500 outline-none" />
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha de Cierre</label>
                <input id="closeTime" type="date" value="${getRelativeDate(0)}" class="w-full border-2 border-slate-100 bg-slate-50 rounded-2xl p-3 focus:border-indigo-500 outline-none" />
            </div>
        `;
            } else {
                d.innerHTML = `
            <input id="title" placeholder="¬øQu√© hay que hacer?" class="w-full border-2 border-slate-100 bg-slate-50 rounded-2xl p-3 focus:border-indigo-500 outline-none" />
            <div class="grid grid-cols-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha L√≠mite</label>
                <input id="deadline" type="date" value="${getRelativeDate(0)}" class="w-full border-2 border-slate-100 bg-slate-50 rounded-2xl p-3 focus:border-indigo-500 outline-none" />
            </div>
        `;
            }
        }

        function saveTask() {
            const cat = document.getElementById('category').value;
            const notesVal = document.getElementById('notes').value;

            let task;
            if (editingTaskId) {
                task = tasks.find(x => x.id === editingTaskId);
            } else {
                task = { id: Date.now(), created: new Date().toISOString(), completed: false };
            }

            task.category = cat;
            task.notes = notesVal;

            if (cat === 'proyecto') {
                task.title = document.getElementById('client').value || 'Sin Nombre';
                task.phone = document.getElementById('phone').value;
                task.address = document.getElementById('address').value;
                task.material = document.getElementById('material').value;
                task.date = document.getElementById('closeTime').value;
            } else {
                task.title = document.getElementById('title').value || 'Nueva Tarea';
                task.date = document.getElementById('deadline').value;
            }

            if (!task.date) task.date = getRelativeDate(0);

            if (!editingTaskId) tasks.push(task);

            saveStorage();
            closeForm();
            render();
        }

        // --- RENDERIZADO ---
        function setView(v) {
            currentView = v;
            render();
        }

        function render() {
            const main = document.getElementById('main');
            const empty = document.getElementById('empty-state');
            main.innerHTML = '';

            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById(`nav-${currentView}`).classList.add('tab-active');

            const todayStr = new Date().toISOString().slice(0, 10);

            let filtered = tasks.filter(t => {
                if (currentView === 'completed') return t.completed;
                if (t.completed) return false;
                if (currentView === 'today') return t.date === todayStr;
                if (currentView === 'week') return isInCurrentWeek(t.date);
                if (currentView === 'month') return isInCurrentMonth(t.date);
                return true;
            });

            filtered.sort((a, b) => a.date.localeCompare(b.date));

            if (filtered.length === 0) {
                empty.classList.replace('hidden', 'flex');
            } else {
                empty.classList.replace('flex', 'hidden');
            }

            filtered.forEach(t => {
                const diff = getDaysDiff(t.date);
                const badge = getDayBadge(diff);
                const isOverdue = diff < 0 && !t.completed;

                const card = document.createElement('div');
                card.className = `
            relative group p-4 rounded-[1.8rem] shadow-sm border border-slate-100
            flex items-center gap-4 active:scale-[0.98] transition-all cursor-pointer
            ${t.completed ? 'task-checked' : ''}
            ${isOverdue ? 'bg-red-50 border-red-100' : 'bg-white'}
        `;

                card.onclick = (e) => {
                    if (!e.target.closest('.check-zone')) openDetail(t.id);
                };

                const iconColor = t.category === 'proyecto' ? 'amber' : 'indigo';
                const iconName = t.category === 'proyecto' ? 'briefcase' : 'check-circle';

                card.innerHTML = `
            <!-- BADGE ARRIBA DERECHA -->
            <span class="absolute top-3 right-3 text-[10px] px-2 py-0.5 rounded-md font-bold ${badge.color}">
                ${badge.text}
            </span>

            <div onclick="event.stopPropagation(); toggleComplete(${t.id})"
                class="check-zone shrink-0 bg-${iconColor}-100 text-${iconColor}-600
                p-3 rounded-2xl transition-transform active:scale-90">
                <i data-lucide="${t.completed ? 'check-square' : iconName}" class="w-6 h-6"></i>
            </div>

            <div class="flex-1 overflow-hidden pr-16">
                <h3 class="font-bold text-slate-800 leading-tight truncate">${t.title}</h3>
                <span class="text-[9px] font-black uppercase tracking-tighter text-slate-400">
                    ${t.category}
                </span>
            </div>
        `;

                main.appendChild(card);
            });

            initIcons();
        }
        initIcons();


        // --- ACCIONES ---
        function toggleComplete(id) {
            const t = tasks.find(x => x.id === id);
            t.completed = !t.completed;
            saveStorage();
            render();
        }

        function openDetail(id) {
            const t = tasks.find(x => x.id === id);
            const diff = getDaysDiff(t.date);
            const badge = getDayBadge(diff);

            let html = `
        <div class="flex justify-between items-start mb-4">
            <span class="px-3 py-1 bg-indigo-100 text-indigo-600 text-[10px] font-black rounded-full uppercase">${t.category}</span>
            <span class="px-3 py-1 ${badge.color} text-[10px] font-black rounded-full uppercase">${badge.text}</span>
        </div>
        <h3 class="text-2xl font-black text-slate-900 mb-6 leading-tight">${t.title}</h3>
        <div class="space-y-3">
    `;

            if (t.category === 'proyecto') {
                html += `
            <div class="p-4 bg-slate-50 rounded-2xl">
    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Contacto</p>
    <div class="flex flex-col font-bold text-slate-700 text-sm">
        <a href="tel:${t.phone}">${t.phone || 'S/N'}</a>
        <a href="https://wa.me/503${t.phone?.replace(/\s/g, '')}" 
           class="text-emerald-600 mt-1 flex items-center gap-1">
            <i data-lucide="message-circle" class="w-3 h-3"></i> WhatsApp
        </a>
    </div>
</div>

<div class="p-4 bg-slate-50 rounded-2xl">
    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Material interesado</p>
    <p class="font-bold text-slate-700 text-sm">${t.material || 'No definido'}</p>
</div>

            <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl text-sm">
                <div class="bg-blue-100 text-blue-600 p-2 rounded-xl"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Ubicaci√≥n</p>
                    <p class="font-bold text-slate-700">${t.address || 'No especificada'}</p>
                </div>
            </div>
        `;
            }

            html += `
        <div class="p-4 border-2 border-slate-50 rounded-2xl">
            <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Notas del Proyecto</p>
            <p class="text-slate-600 text-sm">${t.notes || 'Sin notas registradas.'}</p>
        </div>
        <div class="flex justify-between items-center px-2 py-1">
             <span class="text-[10px] font-bold text-indigo-500 uppercase">Entrega: ${t.date}</span>
             <span class="text-[10px] font-bold text-slate-300 uppercase">ID: ${t.id.toString().slice(-6)}</span>
        </div>
    `;

            document.getElementById('detailContent').innerHTML = html;
            document.getElementById('btnEdit').onclick = () => { closeDetail(); openForm(id); };
            document.getElementById('btnDelete').onclick = () => deleteTask(id);
            document.getElementById('detailModal').classList.add('modal-active');
            initIcons();
        }

        function closeDetail() {
            document.getElementById('detailModal').classList.remove('modal-active');
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveStorage();
            closeDetail();
            render();
        }

        updateHeaderDate();
        render();
    </script>

    <script>lucide.createIcons()</script>
</body>

</html>